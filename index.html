<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>UNDETALLIS — Texto 3D Interactivo</title>

<style>
    body {
        margin: 0;
        overflow: hidden;
        background: black;
        font-family: Arial, sans-serif;
    }
    #fondo {
        position: fixed;
        top: 0;
        left: 0;
        height: 110%;
        width: 110%;
        background-image: url('assets/fondo.jpg');
        background-size: cover;
        background-position: center;
        animation: fondoMovimiento 2.5s infinite ease-in-out alternate;
        filter: blur(6px) brightness(0.7);
        z-index: -2;
    }
    @keyframes fondoMovimiento {
        0% { transform: scale(1.02) translate(-8px, -5px); }
        100% { transform: scale(1.06) translate(6px, 5px); }
    }

    #three-container {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 100vw;
        height: 100vh;
        transform: translate(-50%, -50%);
        z-index: 10;
        touch-action: none;
    }
</style>

</head>
<body>

<div id="fondo"></div>
<div id="three-container"></div>

<!-- THREE.JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r152/three.min.js"></script>
<script src="https://threejs.org/examples/jsm/loaders/FontLoader.js"></script>
<script src="https://threejs.org/examples/jsm/geometries/TextGeometry.js"></script>

<!-- ========================= -->
<!--   FIREBASE + FRASES       -->
<!-- ========================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBJjxw3ONW_WvUgTKeHALYdmUjTOXB0gFs",
  authDomain: "spicy-da7d7.firebaseapp.com",
  projectId: "spicy-da7d7",
  storageBucket: "spicy-da7d7.firebasestorage.app",
  messagingSenderId: "8855941044",
  appId: "1:8855941044:web:3607c0d43293fbc6490ce1",
  measurementId: "G-K5GK8HR3BE"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const frases = [
"Reto: dime qué fue lo primero que pensaste de mí,",
"Reto: báilame como si ya estuviéramos solos,",
"Reto: susúrrame algo que solo yo pueda escuchar,",
"Reto: mírame de cerca sin apartar la mirada,",
"Reto: toca mi mano y dime qué sentiste,",
"Reto: dime una verdad que nunca dices,",
];

function mezclar(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

/* ========================= */
/*   SISTEMA DE TEXTO 3D     */
/* ========================= */
let scene, camera, renderer, textMesh, font;
let targetRotationX = 0;
let targetRotationY = 0;

function init3D() {
    const container = document.getElementById("three-container");

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.z = 180;

    renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    const light = new THREE.PointLight(0xffffff, 1.2);
    light.position.set(50, 50, 200);
    scene.add(light);

    const loader = new THREE.FontLoader();
    loader.load("https://threejs.org/examples/fonts/helvetiker_bold.typeface.json", f => {
        font = f;
        cargarFrase(); // Mostrar la primera frase
    });

    container.addEventListener("pointerdown", startDrag);
    container.addEventListener("pointermove", drag);
    container.addEventListener("pointerup", endDrag);
}

let isDragging = false;
let lastX = 0;
let lastY = 0;

function startDrag(e) {
    isDragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
}

function drag(e) {
    if (!isDragging) return;

    const dx = e.clientX - lastX;
    const dy = e.clientY - lastY;

    targetRotationY += dx * 0.01;
    targetRotationX += dy * 0.01;

    lastX = e.clientX;
    lastY = e.clientY;
}

function endDrag() {
    isDragging = false;
}

function render() {
    requestAnimationFrame(render);

    if (textMesh) {
        textMesh.rotation.y = targetRotationY;
        textMesh.rotation.x = targetRotationX;
    }

    renderer.render(scene, camera);
}

async function cargarFrase() {
    const ordenRef = ref(db, "orden");
    const posRef = ref(db, "pos");

    const ordenSnap = await get(ordenRef);
    const posSnap = await get(posRef);

    let orden = ordenSnap.exists() ? ordenSnap.val() : null;
    let pos = posSnap.exists() ? posSnap.val() : 0;

    if (!orden || orden.length !== frases.length) {
        orden = [...Array(frases.length).keys()];
        mezclar(orden);
        await set(ordenRef, orden);
        pos = 0;
        await set(posRef, 0);
    }

    const frase = frases[orden[pos]];
    mostrarTexto3D(frase);

    pos++;
    if (pos >= frases.length) {
        orden = [...Array(frases.length).keys()];
        mezclar(orden);
        pos = 0;
        await set(ordenRef, orden);
    }

    await set(posRef, pos);
}

function mostrarTexto3D(texto) {
    if (!font) return;

    if (textMesh) scene.remove(textMesh);

    const geo = new THREE.TextGeometry(texto, {
        font: font,
        size: 12,
        height: 4,
        curveSegments: 12,
        bevelEnabled: true,
        bevelThickness: 1,
        bevelSize: 0.8
    });

    const mat = new THREE.MeshStandardMaterial({ color: 0xffffff, metalness: 0.3, roughness: 0.4 });

    textMesh = new THREE.Mesh(geo, mat);

    geo.computeBoundingBox();
    const centerX = - (geo.boundingBox.max.x - geo.boundingBox.min.x) / 2;
    const centerY = - (geo.boundingBox.max.y - geo.boundingBox.min.y) / 2;
    textMesh.position.set(centerX, centerY, 0);

    scene.add(textMesh);
}

window.onload = () => {
    init3D();
    render();
};
</script>
</body>
</html>
